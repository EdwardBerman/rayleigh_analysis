from egnn_pytorch import EGNN_Network
from torch import nn


class EGNN(nn.Module):
    """
    A wrapper around the original EGNN code, docstring autogenerated from the README of the package on Github. 
    """

    def __init__(
        self,
        *,
        depth,
        dim,
        num_tokens=None,
        num_edge_tokens=None,
        num_positions=None,
        edge_dim=0,
        num_adj_degrees=None,
        adj_dim=0,
        global_linear_attn_every=0,
        global_linear_attn_heads=8,
        global_linear_attn_dim_head=64,
        num_global_tokens=4,
        **kwargs
    ):
        super().__init__()

        self.model = EGNN_Network(
            depth=depth,
            dim=dim,
            num_tokens=num_tokens,
            num_edge_tokens=num_edge_tokens,
            num_positions=num_positions,
            edge_dim=edge_dim,
            num_adj_degrees=num_adj_degrees,
            adj_dim=adj_dim,
            global_linear_attn_every=global_linear_attn_every,
            global_linear_attn_heads=global_linear_attn_heads,
            global_linear_attn_dim_head=global_linear_attn_dim_head,
            num_global_tokens=num_global_tokens,
            norm_coors=True,
            **kwargs
        )

        self.transforms = []

    def forward(
        self,
        data
    ):
        node_out, _ = self.model(
            feats=data.x.permute(2, 0, 1),
            coors=data.pos.unsqueeze(0),
            adj_mat=data.adj_mat,
            edges=data.edges_dense,
        )
        return node_out.permute(1, 0, 2)
